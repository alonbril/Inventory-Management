{% extends "base.html" %}
{% block content %}
    <h1>Add New Loan</h1>
    <form method="POST" id="loanForm">
        <div>
            <label for="borrower_name">Borrower Name:</label>
            <input type="text" id="borrower_name" name="borrower_name"
                   value="{{ form_data.borrower_name if form_data else '' }}" required>
        </div>
        <div>
            <label for="green_number">Green Number (Available Items Only):</label>
            <select id="green_number" name="green_number" required onchange="updateItemName(this)">
                <option value="">Select Green Number</option>
                {% for item in available_items %}
                    <option value="{{ item['green_number'] }}"
                            data-name="{{ item['name'] }}"
                            {% if form_data and form_data.green_number|int == item['green_number'] %}selected{% endif %}>
                        {{ item['green_number'] }} - {{ item['name'] }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="item_name">Item Name:</label>
            <input type="text" id="item_name" name="item_name"
                   value="{{ form_data.item_name if form_data else '' }}" required readonly>
        </div>
        <div>
            <label for="loan_date">Loan Date:</label>
            <input type="date" id="loan_date" name="loan_date"
                   value="{{ form_data.loan_date if form_data else '' }}" required>
        </div>

        <div class="signature-container">
            <label>Signature:</label>
            <div class="signature-pad-wrapper">
                <canvas id="signaturePad"></canvas>
            </div>
            <div class="signature-pad-buttons">
                <button type="button" class="button" id="clearPad">Clear Signature</button>
            </div>
            <input type="hidden" name="signature" id="signatureData">
        </div>

        <div class="form-buttons">
            <button type="submit" class="button">Add Loan</button>
            <a href="{{ url_for('loans') }}" class="button cancel">Cancel</a>
        </div>
    </form>

    <!-- Add Currently Loaned Items Section -->
   <div class="loan-status-info">
    <h3>Currently Loaned Items:</h3>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Green Number</th>
                    <th>Item Name</th>
                    <th>Borrower</th>
                    <th>Loan Date</th>
                </tr>
            </thead>
            <tbody>
                {% for loan in active_loans %}
                    <tr>
                        <td>{{ loan['green_number'] }}</td>
                        <td>{{ loan['item_name'] }}</td>
                        <td>{{ loan['borrower_name'] }}</td>
                        <td>{{ loan['loan_date'] }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/4.1.5/signature_pad.umd.min.js"></script>
    <script>
        // Auto-fill item name when green number is selected
        function updateItemName(selectElement) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const itemNameInput = document.getElementById('item_name');
            itemNameInput.value = selectedOption.dataset.name || '';
        }

        // Initialize signature pad
        document.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('signaturePad');
            const signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgb(255, 255, 255)',
                penColor: 'rgb(0, 0, 0)',
                minWidth: 1,
                maxWidth: 2.5
            });

            // Handle window resize
            function resizeCanvas() {
                const wrapper = canvas.parentElement;
                canvas.width = wrapper.clientWidth;
                canvas.height = wrapper.clientHeight;
                signaturePad.clear(); // Clear the canvas
            }

            window.addEventListener('resize', resizeCanvas);
            resizeCanvas(); // Initial resize

            // Clear signature button
            document.getElementById('clearPad').addEventListener('click', function() {
                signaturePad.clear();
            });

            // Form submission
            document.getElementById('loanForm').addEventListener('submit', function(e) {
                e.preventDefault();
                if (signaturePad.isEmpty()) {
                    alert('Please provide a signature');
                    return false;
                }
                document.getElementById('signatureData').value = signaturePad.toDataURL();
                this.submit();
            });
        });
    </script>
{% endblock %}