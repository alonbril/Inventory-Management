{% extends "base.html" %}
{% block content %}

<div class="content">
    <div class="table-container">
        <h1>Add New Loan</h1>

        <form method="POST" class="loan-form" id="loanForm">
            <div class="form-section">
                <div class="form-group">
                    <label for="borrower_name">Borrower Name</label>
                    <input type="text" id="borrower_name" name="borrower_name" required class="search-input"
                        value="{{ form_data.borrower_name if form_data else '' }}">
                </div>

                <!-- Items Section -->
                <div class="form-group" id="items-container">
                    <label>Select Items</label>
                    {% for _ in range(5) %}
                    <div class="item-row" {% if not loop.first %}style="display: none;"{% endif %}>
                        <div class="item-select">
                            <select name="green_numbers[]" class="search-input select2">
                                <option value="">Search by green number or name...</option>
                                {% for item in available_items %}
                                <option value="{{ item.green_number }}">
                                    {{ item.green_number }} - {{ item.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        {% if not loop.first %}
                        <button type="button" class="button delete remove-item" onclick="removeItem(this)">Remove</button>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                <button type="button" id="add-item" class="button add" onclick="addItem()">Add More Items</button>

                <div id="selected-items-preview" class="preview-container" style="display: none;">
                    <h3>Selected Items:</h3>
                    <div class="selected-items-list"></div>
                </div>

                <!-- Equipment Toggle -->
                <div class="equipment-toggle">
                    <label class="checkbox-label">
                        <input type="checkbox" id="include-equipment" name="include_equipment">
                        <span class="checkbox-text">Include Additional Equipment</span>
                    </label>
                </div>

                <!-- Equipment Section -->
                <div id="equipment-container" style="display: none;">
                    {% for _ in range(5) %}
                    <div class="equipment-row" {% if not loop.first %}style="display: none;"{% endif %}>
                        <div class="equipment-select">
                            <select name="equipment[]" class="search-input select2">
                                <option value="">Select Equipment</option>
                                <option value="Charger">Charger</option>
                                <option value="Laptop Case">Laptop Case</option>
                                <option value="HDMI Cable">HDMI Cable</option>
                                <option value="Mouse">Mouse</option>
                            </select>
                        </div>
                        <div class="equipment-quantity">
                            <input type="number" name="equipment_quantity[]" value="1" min="1" class="search-input">
                        </div>
                        {% if not loop.first %}
                        <button type="button" class="button delete remove-equipment" onclick="removeEquipment(this)">Remove</button>
                        {% endif %}
                    </div>
                    {% endfor %}

                    <button type="button" id="add-equipment" class="button add" onclick="addEquipment()">Add More Equipment</button>

                    <div id="selected-equipment-preview" class="preview-container" style="display: none;">
                        <h3>Selected Equipment:</h3>
                        <div class="selected-equipment-list"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="loan_date">Loan Date</label>
                    <input type="date" id="loan_date" name="loan_date" required class="search-input">
                </div>

                <div class="signature-container">
                    <label>Signature</label>
                    <div class="signature-pad-wrapper">
                        <canvas id="signaturePad"></canvas>
                    </div>
                    <div class="signature-pad-buttons">
                        <button type="button" class="clear-button">Clear</button>
                    </div>
                    <input type="hidden" name="signature" id="signatureData">
                </div>
            </div>

            <div class="form-buttons">
                <button type="submit" class="button add">Add Loan</button>
                <a href="{{ url_for('loans') }}" class="button cancel">Cancel</a>
            </div>
        </form>
    </div>
</div>

<script>
// Initialize signature pad
var canvas = document.getElementById('signaturePad');
var signaturePad;

function initializeSignaturePad() {
    var wrapper = document.querySelector('.signature-pad-wrapper');
    var rect = wrapper.getBoundingClientRect();

    // Set canvas size to match wrapper size in actual pixels
    var ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = rect.width * ratio;
    canvas.height = rect.height * ratio;

    var context = canvas.getContext("2d");
    context.scale(ratio, ratio);

    // Set canvas size in CSS pixels
    canvas.style.width = rect.width + 'px';
    canvas.style.height = rect.height + 'px';

    if (signaturePad) {
        signaturePad.clear();
    }

    signaturePad = new SignaturePad(canvas, {
        backgroundColor: 'rgb(255, 255, 255)',
        penColor: 'rgb(0, 0, 0)',
        velocityFilterWeight: 0.5,
        minWidth: 0.5,
        maxWidth: 2.5,
        throttle: 16,
        minDistance: 3
    });
        // Clear signature button
    const clearButton = document.querySelector('.clear-button');
    if (clearButton) {
        clearButton.addEventListener('click', function(e) {
            e.preventDefault();
            signaturePad.clear();
        });
    }
}

// Add item row
function addItem() {
    var container = document.getElementById('items-container');
    var hiddenRows = container.querySelectorAll('.item-row[style*="display: none"]');

    if (hiddenRows.length > 0) {
        hiddenRows[0].style.display = '';
        var select = hiddenRows[0].querySelector('select');
        $(select).select2({
            width: '100%',
            placeholder: 'Select an option'
        });
        updateItemsPreview();
    }
}

// Remove item row
function removeItem(button) {
    var row = button.closest('.item-row');
    var select = row.querySelector('select');
    select.value = '';
    $(select).trigger('change');
    row.style.display = 'none';
    updateItemsPreview();
}

// Add equipment row
function addEquipment() {
    var container = document.getElementById('equipment-container');
    var hiddenRows = container.querySelectorAll('.equipment-row[style*="display: none"]');

    if (hiddenRows.length > 0) {
        hiddenRows[0].style.display = '';
        var select = hiddenRows[0].querySelector('select');
        $(select).select2({
            width: '100%',
            placeholder: 'Select an option'
        });
        updateEquipmentPreview();
    }
}

// Remove equipment row
function removeEquipment(button) {
    var row = button.closest('.equipment-row');
    var select = row.querySelector('select');
    select.value = '';
    $(select).trigger('change');
    row.style.display = 'none';
    updateEquipmentPreview();
}

// Equipment toggle handler
document.getElementById('include-equipment').addEventListener('change', function() {
    const equipmentContainer = document.getElementById('equipment-container');
    if (this.checked) {
        equipmentContainer.style.display = 'block';
    } else {
        equipmentContainer.style.display = 'none';
        // Clear all equipment selections
        const equipmentSelects = equipmentContainer.querySelectorAll('select[name="equipment[]"]');
        equipmentSelects.forEach(select => {
            select.value = '';
            $(select).trigger('change');
        });
        updateEquipmentPreview();
    }
});

// Update items preview
function updateItemsPreview() {
    var preview = document.getElementById('selected-items-preview');
    var list = preview.querySelector('.selected-items-list');
    var items = [];

    document.querySelectorAll('select[name="green_numbers[]"]').forEach(function(select) {
        if (select.value && select.closest('.item-row').style.display !== 'none') {
            items.push(select.options[select.selectedIndex].text);
        }
    });

    if (items.length > 0) {
        list.innerHTML = items.map(item => '<div>' + item + '</div>').join('');
        preview.style.display = '';
    } else {
        preview.style.display = 'none';
    }
}

// Update equipment preview
function updateEquipmentPreview() {
    var preview = document.getElementById('selected-equipment-preview');
    var list = preview.querySelector('.selected-equipment-list');
    var equipment = [];

    document.querySelectorAll('.equipment-row').forEach(function(row) {
        if (row.style.display !== 'none') {
            var select = row.querySelector('select[name="equipment[]"]');
            var quantity = row.querySelector('input[name="equipment_quantity[]"]');
            if (select.value) {
                equipment.push(quantity.value + 'x ' + select.options[select.selectedIndex].text);
            }
        }
    });

    if (equipment.length > 0) {
        list.innerHTML = equipment.map(item => '<div>' + item + '</div>').join('');
        preview.style.display = '';
    } else {
        preview.style.display = 'none';
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeSignaturePad();


    // Initialize Select2 for all visible selects
    document.querySelectorAll('select.select2:not([style*="display: none"])').forEach(function(select) {
        $(select).select2({
            width: '100%',
            placeholder: 'Select an option'
        });
    });

    // Add change event listeners
    document.querySelectorAll('select[name="green_numbers[]"]').forEach(function(select) {
        $(select).on('change', updateItemsPreview);
    });

    document.querySelectorAll('select[name="equipment[]"], input[name="equipment_quantity[]"]').forEach(function(element) {
        $(element).on('change', updateEquipmentPreview);
    });

    // Clear signature button
    document.getElementById('clearSignature').addEventListener('click', function() {
        signaturePad.clear();
        var clearButton = document.querySelector(".clear-button");
        if (clearButton) {
            clearButton.addEventListener("click", function(e) {
                e.preventDefault();
                signaturePad.clear();
            });
        }
    });

    // Set today's date as default
    var today = new Date().toISOString().split('T')[0];
    document.getElementById('loan_date').value = today;
});

// Handle window resize
window.addEventListener("resize", initializeSignaturePad);

// Form submission handler
document.getElementById('loanForm').addEventListener('submit', function(e) {
    e.preventDefault();

    if (signaturePad.isEmpty()) {
        alert('Please provide a signature');
        return false;
    }


    document.getElementById('signatureData').value = signaturePad.toDataURL();

    var hasSelectedItems = false;
    document.querySelectorAll('select[name="green_numbers[]"]').forEach(function(select) {
        if (select.value && select.closest('.item-row').style.display !== 'none') {
            hasSelectedItems = true;
        }
    });

    if (!hasSelectedItems) {
        alert('Please select at least one item');
        return false;
    }

    this.submit();
});
</script>

{% endblock %}